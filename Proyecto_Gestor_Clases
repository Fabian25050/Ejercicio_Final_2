import json
from datetime import datetime

class Usuario:
    def __init__(self, nombre_usuario, contrasena):
        self.nombre = nombre_usuario
        self.contrasena = contrasena
        self.tareas = []

    def agregar_tarea(self, tarea):
        self.tareas.append(tarea)

    def eliminar_tarea(self, nombre_tarea):
        self.tareas = (tarea for tarea in self.tareas if tarea != nombre_tarea)


    def mostrar_tareas(self):
        if self.tareas:
            i = 1
            for tarea in self.tareas:
                print(f"{i}. {tarea.nombre_tarea}: {tarea.descripcion}, con fecha de vencimiento {tarea.fecha_vencimiento}.")
                i =+ 1
            
            for num, info in enumerate(tarea, start=1):
                print(f"{num}. {info.nombre_tarea}: {info.descripcion}, con fecha de vencimiento {info.fecha_vencimiento}.")

        else:
            print("No tienes tareas")


class Tareas:
    def __init__(self, nombre_tarea, descripcion, fecha_vencimiento):
        self.nombre_tarea = nombre_tarea
        self.descripcion = descripcion
        self.fecha_vencimiento = fecha_vencimiento
        self.completado = False

    def editar_tarea(self, nuevo_nombre, nueva_descripcion, nueva_fv):
        self.nombre_tarea = nuevo_nombre
        self.descripcion = nueva_descripcion
        self.fecha_vencimiento = nueva_fv

    def completar_tarea(self):
        self.completado = True
        



class Gestor:
    def __init__(self, nombre_archivo = "Datos de proyecto.json"):
        self.usuarios = {}
        self.nombre_archivo = nombre_archivo
        self.cargar_datos()


    def cargar_datos(self):
        try:
            with open(self.nombre_archivo, "r") as archivo:
                datos = json.load(archivo)
                for nombre_usuario, datos_usuario in datos.items:
                    usuario = Usuario(nombre_usuario, datos_usuario["contrasena"])
                    for contrasena, lista_tareas in datos_usuario.items:
                        tarea = Tareas(lista_tareas["nombre_tarea"], lista_tareas["descripcion"], lista_tareas["fecha_vencimiento"])
                        tarea.completado = lista_tareas["completado"]
                        usuario.agregar_tarea(tarea)
                    self.usuarios[nombre_usuario] = usuario

        except FileNotFoundError:
           print("No se encontro el archivo, se va a crear uno.") 

    def guardar_datos(self):
        with open(self.nombre_archivo, "w") as archivo:
            datos_guardados = {}
            for nombre_usr, datos in self.usuarios.items:
                datos_guardados[nombre_usr] = {
                    "contrasena": datos.contrasena,
                    "tareas": [{
                        "nombre_tarea": tarea.nombre_tarea,
                        "descripcion": tarea.descripcion,
                        "fecha_vencimiento": tarea.fecha_vencimiento,
                        "completado": tarea.completado
                    } for tarea in datos.tareas]
                }

            json.dump(archivo, datos_guardados)

    def registrar_usuario(self, usuario, contrasena):
        if usuario in self.usuarios:
            print("Este usuario ya esta registrado")
            return False
        
        self.usuarios[usuario] = Usuario(usuario, contrasena)
        self.guardar_datos()
        return True
    
    def iniciar_sesion(self, nombre_usuario, contrasena):
        usuario = self.usuarios.get(nombre_usuario)
        if usuario and usuario.contrasena == contrasena:
            print(f"Bienvenido {nombre_usuario}")
            return usuario
        print("Usuario no registrado")
        return None
    
    def menu_sistema(self, usuario):
        while(True):
            print("Menu de usuario, seleccione una opción:")
            print("1. Crear una tarea")
            print("2. Editar una tarea")
            print("3. Ver tareas")
            print("4. Salir")
            menu_s = input("Introduzca la opción que desee realizar: ")

            if menu_s == 1:
                tarea_titulo = input("Introduzca el título de la tarea: ")
                tarea_descripcion = input("Introduzca la descripción de la tarea: ")
                tarea_fecha_vencimiento = input("Introduzca la fecha de vencimiento de la tarea:")
                tarea = Tareas(tarea_titulo, tarea_descripcion, tarea_fecha_vencimiento)
                usuario.agregar_tarea(tarea)
                self.guardar_datos()

            if menu_s == 2:
                usuario.mostrar_tareas()
                tarea_antigua = input("Cual es la tarea que quieres modificar? (número): ")
                tarea_2 = usuario.tareas[tarea_antigua + 1] 
                tarea_titulo = input("Introduzca el nuevo título de la tarea: ")
                tarea_descripcion = input("Introduzca la nueva descripción de la tarea: ")
                tarea_fecha_vencimiento = input("Introduzca la nueva fecha de vencimiento de la tarea:")
                tarea_2.editar_tarea(tarea_titulo, tarea_descripcion, tarea_fecha_vencimiento)
                self.guardar_datos()





if __name__ == "__main__":
    systema = Gestor()
    while(True):
        print("Este es el sistema gestor de tareas V1.0, eliga una de las opciones para continuar:")
        print("\n1. Iniciar sesión")
        print("\n2. Registrarse")
        print("\n3. Salir")
        menu_p = input("Introduzca el número de su elección: ")

        if menu_p == 1:
            usuario_m = input("Introduzca su nombre de usuario: ")
            contrasena_m = input("Introduzca su contraseña: ")


            systema.menu_sistema(usuario)
            

        if menu_p == 2:
            print("Para la creación ")
        


fabian = Usuario("fabian", 1234)
fabian.crear_tarea()
fabian.eliminar_tarea("a")




